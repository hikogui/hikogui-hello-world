#
# .github/workflows/build-on-windows.yml
#
# Copyright 2021 Jens A. Koch.
# SPDX-License-Identifier: BSL-1.0
# This file is part of hikogui.
#

name: "Build on Windows"
on: [push, pull_request]
jobs:
  build:
    name: ${{matrix.config.NAME}}
    # https://github.com/actions/virtual-environments/blob/main/images/win/Windows2019-Readme.md
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        # Each entry in config has a:
        # - NAME: The name used as the suffix in files, directories and artifacts.
        # - CMAKE_BUILD_TYPE: The executable type Debug/Release/RelWithDbg to build.
        config:
          - {
              NAME: vc17-x64-windows-dbg,
              CMAKE_BUILD_TYPE: Debug
            }
          - {
              NAME: vc17-x64-windows-rel,
              CMAKE_BUILD_TYPE: Release
            }

    steps:
      - name: ğŸ”½ Checkout Code
        uses: actions/checkout@v4 # https://github.com/actions/checkout

      - name: ğŸ”½ Checkout HikoGUI Code
        uses: actions/checkout@v4 # https://github.com/actions/checkout
        with:
          repository: hikogui/hikogui
          path: external/hikogui

      # Build Artifact
      # ---------------
      # The ECPACK artifact contains files for building a signed installer, including the "ecpack.json" manifest file.
      #
      # Naming Scheme:
      #
      #  - $ECPACK_NAME  :  hikogui-hello-world-0.3.0-win64
      #
      # When we package the ECPACK artifact:
      #
      #  - ${{ECPACK_NAME}} is used to create a .json file and a storage directory with the suffix "-files"
      #  - ${{ECPACK_NAME}}-ecpack is used to name the final ecpack.zip file
      #
      - name: ğŸ“ Fetch version data & set build artifact names
        shell: pwsh
        run: |
          $NAME=$(jq -r .name vcpkg.json).replace('-', '_')
          $VERSION=$(jq -r .version vcpkg.json)
          echo "ECPACK_NAME=$NAME-$VERSION-win64" >> $env:GITHUB_ENV

      - name: ğŸ“ Get Vulkan SDK version number
        id: vulkan-version
        uses: hikogui/install-vulkan-sdk-action/sdk-version@v3

      - name: ğŸ¯ Cache VULKAN SDK & Runtime
        id: cache-vulkan
        uses: actions/cache@v1
        with:
          path: ${{steps.vulkan-version.outputs.VULKAN_SDK}}
          key: cache-windows-vulkan-${{steps.vulkan-version.outputs.VULKAN_VERSION}}-2

      - name: ğŸ”½ Install Vulkan SDK
        if: steps.cache-vulkan.outputs.cache-hit != 'true'
        uses: hikogui/install-vulkan-sdk-action/install-sdk@v3
        with:
          VULKAN_VERSION: ${{steps.vulkan-version.outputs.VULKAN_VERSION}}
          VULKAN_SDK: ${{steps.vulkan-version.outputs.VULKAN_SDK}}

      - name: ğŸ› ï¸ Setup Visual Studio Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
  
      - name: âœ CMake â” Make Build Directory (HikoGUI)
        shell: pwsh
        run: mkdir "external/hikogui/build"

      - name: âœ CMake â” Configure (HikoGUI)
        working-directory: external/hikogui/build
        shell: pwsh
        run: cmake -G Ninja "-DCMAKE_BUILD_TYPE=${{matrix.config.CMAKE_BUILD_TYPE}}" "-DCMAKE_INSTALL_PREFIX=../install" "-DBUILD_TESTING=OFF" "-DBUILD_EXAMPLES=OFF" ..

      - name: ğŸ™ CMake â” Build (HikoGUI)
        working-directory: external/hikogui/build
        run: cmake --build . --parallel 1

      - name: ğŸ“¦ CMake â” Install (HikoGUI)
        working-directory: external/hikogui/build
        run: cmake --install .

      - name: âœ CMake â” Make Build Directory (Hello World)
        shell: pwsh
        run: mkdir "build"

      - name: âœ CMake â” Configure (Hello World)
        working-directory: build
        env:
          VULKAN_SDK: ${{steps.vulkan-version.outputs.VULKAN_SDK}}
        shell: pwsh
        run: cmake -G Ninja "-DCMAKE_BUILD_TYPE=${{matrix.config.CMAKE_BUILD_TYPE}}" "-DCMAKE_INSTALL_PREFIX=../install" "-DCMAKE_PREFIX_PATH=../external/hikogui/install" "-DINSTALL_PDB=OFF" ..

      - name: ğŸ™ CMake â” Build (Hello World)
        working-directory: build
        run: cmake --build . --parallel 1

      - name: ğŸ“¦ CMake â” Package (Hello World)
        working-directory: build
        run: |
          cpack .
          copy "${{env.ECPACK_NAME}}.json" "${{env.ECPACK_NAME}}-files\ecpack.json"

      - name: ğŸš€ Upload Artifact â” ECPACK
        uses: actions/upload-artifact@v2
        if: matrix.config.CMAKE_BUILD_TYPE == 'Release'
        with:
          name: ${{env.ECPACK_NAME}}-ecpack
          path: build\${{env.ECPACK_NAME}}-files\
